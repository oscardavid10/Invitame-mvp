<section class="container mx-auto px-5 py-10">
  <h1 class="text-2xl font-bold mb-1">Crea tu invitaci√≥n ‚Äî Plan <%= plan.name %></h1>
  <p class="text-[var(--ring)] text-sm mb-6">
    Incluye: <%= plan.max_images %> im√°genes ¬∑ Video: <%= plan.allow_video ? 'S√≠' : 'No' %> ¬∑ Transiciones: <%= plan.allow_transitions ? 'S√≠' : 'No' %> ¬∑ Plantillas: <%= plan.template_scope==='general' ? 'General' : plan.template_scope==='all' ? 'Todas' : 'Premium' %>
  </p>

  <% 
    const STEPS = Array.isArray(steps) ? steps : [];
    const stepIndex = (k)=> (STEPS.findIndex(s=>s.key===k)+1);
    const PREVIEW_STEP = stepIndex('preview');
    const MAX_STEPS   = STEPS.length;
  %>

  <!-- Stepper -->
  <ol class="flex flex-wrap gap-2 text-xs mb-6">
    <% STEPS.forEach((s,i)=>{ %>
      <li class="px-2 py-1 rounded-full border border-white/15" id="chip-<%= i+1 %>">
        <span class="opacity-70"><%= i+1 %>.</span> <%= s.label %>
      </li>
    <% }) %>
  </ol>

  <!-- Barra de navegaci√≥n del wizard (arriba, sticky) -->
  <div class="sticky top-0 z-10 bg-[color:var(--bg)]/70 backdrop-blur border-b border-white/10 py-2 mb-4">
    <div class="flex justify-between px-1">
      <button type="button" class="btn btn-ghost" id="btnPrevTop">Anterior</button>
      <button type="button" class="btn btn-primary" id="btnNextTop">Siguiente</button>
    </div>
  </div>

  <form id="wz" class="grid gap-5">
    <input type="hidden" name="plan_code" value="<%= plan.code %>">

    <!-- 1. T√≠tulo -->
    <div class="card step <%= (step !== stepIndex('title')) ? 'hidden' : '' %>" data-step="<%= stepIndex('title') %>">
      <label class="block mb-2">T√≠tulo del evento</label>
      <input class="rounded bg-black/30 px-3 py-2 w-full" name="title" placeholder="Boda de Ana & Luis" required>
    </div>

    <!-- 2. Fecha -->
    <div class="card step <%= (step !== stepIndex('date')) ? 'hidden' : '' %>" data-step="<%= stepIndex('date') %>">
      <label class="block mb-2">Fecha</label>
      <input class="rounded bg-black/30 px-3 py-2" type="date" name="date" required>
    </div>

    <!-- 3. Hora -->
    <div class="card step <%= (step !== stepIndex('time')) ? 'hidden' : '' %>" data-step="<%= stepIndex('time') %>">
      <label class="block mb-2">Hora</label>
      <input class="rounded bg-black/30 px-3 py-2" type="time" name="time" required>
    </div>

    <!-- 4. Domicilio + mapa -->
    <div class="card step <%= (step !== stepIndex('address')) ? 'hidden' : '' %>" data-step="<%= stepIndex('address') %>">
      <div class="grid md:grid-cols-2 gap-3">
        <div>
          <label class="block mb-2">Lugar</label>
          <input class="rounded bg-black/30 px-3 py-2 w-full" name="venue" placeholder="Sal√≥n Principal" required>
          <label class="block mt-4 mb-2">Direcci√≥n</label>
          <input class="rounded bg-black/30 px-3 py-2 w-full" name="address" placeholder="Calle 123, Colonia, Ciudad" required>
          <label class="flex items-center gap-2 mt-4">
            <input type="checkbox" name="show_map"> Mostrar mapa en la invitaci√≥n
          </label>
        </div>
        <div>
          <div class="text-sm text-[var(--ring)] mb-2">Vista de mapa (aprox.)</div>
          <div class="rounded overflow-hidden aspect-video bg-black/20">
            <iframe id="mapFrame" class="w-full h-full" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
          </div>
          <div class="text-xs text-[var(--ring)] mt-1">El mapa se genera con Google Maps (embed) usando tu direcci√≥n.</div>
        </div>
      </div>
    </div>

    <!-- 5. Vestimenta -->
    <div class="card step <%= (step !== stepIndex('dress')) ? 'hidden' : '' %>" data-step="<%= stepIndex('dress') %>">
      <label class="block mb-2">C√≥digo de vestimenta</label>
      <select class="rounded bg-black/30 px-3 py-2" name="dress_code">
        <option value="">(No especificar)</option>
        <option value="Formal">Formal</option>
        <option value="Coctel">Coctel</option>
        <option value="Etiqueta">Etiqueta</option>
        <option value="Casual elegante">Casual elegante</option>
        <option value="Tem√°tico">Tem√°tico</option>
      </select>
    </div>

    <!-- 6. Mensaje -->
    <div class="card step <%= (step !== stepIndex('message')) ? 'hidden' : '' %>" data-step="<%= stepIndex('message') %>">
      <label class="block mb-2">Mensaje especial</label>
      <textarea class="rounded bg-black/30 px-3 py-2 w-full" rows="4" name="message" placeholder="Reserva la fecha y acomp√°√±anos a celebrar..."></textarea>
    </div>

    <% if (stepIndex('registry')) { %>
      <!-- Mesa de Regalos -->
      <div class="card step <%= (step !== stepIndex('registry')) ? 'hidden' : '' %>" data-step="<%= stepIndex('registry') %>">
        <label class="block mb-2">Mesa de regalos</label>
        <textarea class="rounded bg-black/30 px-3 py-2 w-full" rows="4" name="registry" placeholder="Pega aqu√≠ enlaces (uno por l√≠nea) o instrucciones&#10;https://www.amazon.com/tu-lista&#10;https://mesaderegalos.com/mi-evento"></textarea>
        <p class="text-xs text-[var(--ring)] mt-2">Se mostrar√°n como botones o texto en la invitaci√≥n.</p>
      </div>
    <% } %>

    <% if (stepIndex('music')) { %>
      <!-- M√∫sica -->
      <div class="card step <%= (step !== stepIndex('music')) ? 'hidden' : '' %>" data-step="<%= stepIndex('music') %>">
        <label class="block mb-2">M√∫sica (URL de audio)</label>
        <input class="rounded bg-black/30 px-3 py-2 w-full" name="music_url" type="url" placeholder="https://tu-servidor.com/cancion.mp3">
        <label class="flex items-center gap-2 mt-3">
          <input type="checkbox" name="music_autoplay"> Reproducir autom√°ticamente (el navegador puede bloquearlo)
        </label>
      </div>
    <% } %>

    <!-- Plantillas -->
    <%
      const P     = (typeof pref !=='undefined' && pref) ? pref : {};
      const CATS  = (typeof cats !=='undefined' && Array.isArray(cats)) ? cats : [];
      const TMPLS = (typeof templates !=='undefined' && Array.isArray(templates)) ? templates : [];
    %>
    <div class="card step <%= (step !== stepIndex('template')) ? 'hidden' : '' %>" data-step="<%= stepIndex('template') %>">
      <label class="block mb-2">Elige una plantilla</label>

      <div class="grid md:grid-cols-4 gap-3">
        <% CATS.forEach(c=> { %>
          <% TMPLS.filter(t=> t.category === c).forEach(t => { 
               const isChecked = (P.template_key === t.key_name) ? 'checked' : '';
          %>
            <label class="block border border-white/10 rounded-xl p-2 hover:border-white/30 cursor-pointer relative">
              <input type="radio" class="mr-1" name="template_key" value="<%= t.key_name %>" <%= isChecked %> >
              <span class="text-sm font-semibold"><%= c %> ‚Äî <%= t.name %></span>
              <img class="rounded mt-2 aspect-video object-cover w-full" src="<%= t.preview_img || '/public/img/template-placeholder.jpg' %>" alt="">
            </label>
          <% }) %>
        <% }) %>
      </div>

      <div class="text-xs text-[var(--ring)] mt-2">
        Tu plan: <%= plan.template_scope==='general' ? 'General' : plan.template_scope==='all' ? 'Todas' : 'Premium' %>.
        Si alguna plantilla est√° fuera de tu plan, se te ofrecer√° mejorar antes de pagar.
      </div>
    </div>

    <!-- Preview / Publicar -->
    <div class="card step <%= (step !== PREVIEW_STEP) ? 'hidden' : '' %>" data-step="<%= PREVIEW_STEP %>">
      <div class="rounded overflow-hidden border border-white/10">
        <iframe id="previewFrame" class="w-full" style="height: 70vh" loading="lazy"></iframe>
      </div>
      <div class="text-xs text-[var(--ring)] mt-2">Puedes regresar a pasos anteriores y ajustar antes de pagar.</div>
    </div>
  </form>
</section>

<!-- Formularios ocultos -->
<form id="form-preview"  method="post" action="/site/crear/preview"   class="hidden"></form>
<form id="form-continue" method="post" action="/site/crear/continuar" class="hidden"></form>

<script>
(() => {
  const wz     = document.getElementById('wz');
  const steps  = [...document.querySelectorAll('.step')];
  const chips  = [...document.querySelectorAll('[id^="chip-"]')];
  const btnPrev= document.getElementById('btnPrevTop');
  const btnNext= document.getElementById('btnNextTop');
  const iframe = document.getElementById('previewFrame');

  // üî¢ √≠ndices inyectados desde EJS
  const PREVIEW_STEP = <%= PREVIEW_STEP %>;
  const TOTAL_STEPS  = <%= MAX_STEPS %>;
  let step = <%= Number(step) || 1 %>;

  const LS_KEY = 'crear_state_v1';

  function saveState(){
    const fd=new FormData(wz); const obj={};
    fd.forEach((v,k)=> obj[k]=v);
    obj.show_map = wz.elements['show_map']?.checked ? 'on' : '';
    obj.music_autoplay = wz.elements['music_autoplay']?.checked ? 'on' : '';
    localStorage.setItem(LS_KEY, JSON.stringify(obj));
  }
  function loadState(){
    try{
      const obj=JSON.parse(localStorage.getItem(LS_KEY) || '{}');
      Object.entries(obj).forEach(([k,v])=>{
        const el=wz.elements[k]; if(!el) return;
        if(el.type==='checkbox') el.checked=(v==='on'); else el.value=v;
      });
      updateMap();
    }catch{}
  }

  function updateMap(){
    const addr=(wz.elements['address']?.value || '').trim();
    const show=wz.elements['show_map']?.checked;
    const frame=document.getElementById('mapFrame');
    if(!frame) return;
    if(show && addr){ frame.src = `https://www.google.com/maps?q=${encodeURIComponent(addr)}&output=embed`; }
    else { frame.removeAttribute('src'); }
  }

  function buildUrlEncodedFrom(form){
    const fd=new FormData(form);
    if(!fd.has('show_map'))        fd.set('show_map','');
    if(!fd.has('music_autoplay'))  fd.set('music_autoplay','');
    const up=new URLSearchParams();
    for(const [k,v] of fd.entries()) up.append(k,v);
    return up.toString();
  }

  let tPrev=null;
  function schedulePreview(ms=150){ clearTimeout(tPrev); tPrev=setTimeout(renderPreview, ms); }

  async function renderPreview(){
    if(!iframe) return;
    try{
      saveState();
      const res=await fetch('/site/crear/preview',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body: buildUrlEncodedFrom(wz),
        credentials:'same-origin'
      });
      iframe.srcdoc = await res.text();
    }catch(e){ console.error('preview error', e); }
  }

  function publishAndPay(){
    const form=document.getElementById('form-continue');
    form.innerHTML='';
    const qs=new URLSearchParams(buildUrlEncodedFrom(wz));
    for(const [k,v] of qs.entries()){
      const i=document.createElement('input');
      i.type='hidden'; i.name=k; i.value=v;
      form.appendChild(i);
    }
    form.submit();
  }

  function showStep(n){
    step = Math.max(1, Math.min(TOTAL_STEPS, n));
    steps.forEach(s => s.classList.toggle('hidden', Number(s.dataset.step) !== step));
    chips.forEach((c,i)=>{
      c.classList.toggle('bg-white/10', (i+1)===step);
      c.classList.toggle('opacity-60',  (i+1)> step);
    });
    btnPrev.disabled = (step===1);

    if(step === PREVIEW_STEP){
      btnNext.textContent = 'Publicar y pagar';
      renderPreview();
    }else{
      btnNext.textContent = 'Siguiente';
    }
  }

  // Navegaci√≥n
  btnPrev.onclick = ()=>{ saveState(); showStep(step-1); };
  btnNext.onclick = ()=>{ 
    saveState(); 
    (step === PREVIEW_STEP) ? publishAndPay() : showStep(step+1);
  };

  // Cambios que afectan preview
  wz.addEventListener('input',  e => { if(e.target.name==='address') updateMap(); if(step===PREVIEW_STEP) schedulePreview(); });
  wz.addEventListener('change', e => { if(e.target.name==='show_map') updateMap(); if(step===PREVIEW_STEP) schedulePreview(); });

  // Cambiar plantilla refresca preview si ya est√°s en preview
  wz.querySelectorAll('input[name="template_key"]').forEach(r=>{
    r.addEventListener('change', ()=> { if(step===PREVIEW_STEP) schedulePreview(0); });
  });

  // Init
  loadState();
  showStep(step);
})();
</script>
