diff --git a/server.js b/server.js
index 7b3b5ab..e8c1a4a 100644
--- a/server.js
+++ b/server.js
@@ -66,12 +66,23 @@ app.use('/public', express.static(path.join(__dirname, 'public')))
 // inyecta DB
 app.use((req, res, next) => {
   req.db = pool
-  // Fallbacks para que _layout.ejs nunca reciba undefined
-  res.locals.theme = res.locals.theme || {};
-  res.locals.tpl   = res.locals.tpl   || 'default';
-  res.locals.uid   = req.session?.uid || null;
-  res.locals.email = req.session?.email || null;
-  res.locals.hideNav = false;
+  // Fallbacks para layout y usuario
+  res.locals.theme    = res.locals.theme    || {}
+  res.locals.tpl      = res.locals.tpl      || 'default'
+  res.locals.uid      = req.session?.uid    || null
+  res.locals.email    = req.session?.email  || null
+  res.locals.hideNav  = false
+  res.locals.user     = {
+    id: req.session?.uid || null,
+    email: req.session?.email || null,
+    is_admin: !!req.session?.is_admin
+  }
   next();
 });
 
diff --git a/views/_layout.ejs b/views/_layout.ejs
index 9f1b7a1..c3a2f71 100644
--- a/views/_layout.ejs
+++ b/views/_layout.ejs
@@ -133,8 +133,40 @@
   </style>
 </head>
-<body class="tpl-<%= tplKey %>">
-  <%- body %>
+<body class="tpl-<%= tplKey %>">
+  <!-- Topbar b√°sico (condicional) -->
+  <div class="sticky top-0 z-30 bg-[color:var(--bg)]/80 backdrop-blur border-b border-white/10 pt-[env(safe-area-inset-top,6px)]">
+    <div class="max-w-6xl mx-auto px-4 py-2 flex items-center gap-3">
+      <a href="/" class="text-sm opacity-80 hover:opacity-100">Inv√≠tame</a>
+      <div class="ml-auto flex items-center gap-2">
+        <% if (user && user.id) { %>
+          <a href="/panel" class="btn btn-ghost text-sm">Panel</a>
+          <form method="post" action="/auth/logout" class="inline">
+            <button class="btn btn-primary text-sm">Salir</button>
+          </form>
+        <% } else { %>
+          <a href="/auth/login" class="btn btn-ghost text-sm">Iniciar sesi√≥n</a>
+          <a href="/auth/register" class="btn btn-primary text-sm">Registrarme</a>
+        <% } %>
+      </div>
+    </div>
+  </div>
+
+  <main class="mt-3">
+    <%- body %>
+  </main>
 </body>
 </html>
diff --git a/routes/panel.js b/routes/panel.js
index 6c3a2ab..b2e87a1 100644
--- a/routes/panel.js
+++ b/routes/panel.js
@@ -1,9 +1,12 @@
 import { Router } from 'express'
 const router = Router()
 
+// üëá middleware simple auth
 function requireAuth(req,res,next){
   if(!req.session?.uid) return res.redirect('/auth/login?next=' + encodeURIComponent(req.originalUrl))
   next()
 }
 
+// --------- VISTAS ---------
 router.get('/', requireAuth, async (req,res) => {
   const [rows] = await req.db.query(
     'SELECT * FROM invitations WHERE user_id=? ORDER BY created_at DESC', [req.session.uid]
   )
   res.render('panel/index', { invitations: rows, title:'Panel' })
 })
 
+// Wizard (edici√≥n de una invitaci√≥n existente o nueva)
 router.get('/wizard/:id?', requireAuth, async (req,res) => {
   const id = req.params.id
   let invitation = null
@@ -18,10 +21,99 @@ router.get('/wizard/:id?', requireAuth, async (req,res) => {
   const [templates] = await req.db.query('SELECT key_name,name,category,preview_img FROM templates ORDER BY sort_order,id')
   const cats = [...new Set(templates.map(t=>t.category))]
 
+  // plan (simples: por ahora desde orders -> plan)
+  let plan = { code:'basic', name:'B√°sico', template_scope:'general', allow_video:0, allow_transitions:0, max_images:12, allow_registry:0, allow_music:0 }
+  if (invitation?.order_id) {
+    const [[p]] = await req.db.query(
+      `SELECT p.* FROM plans p
+       JOIN orders o ON o.plan_id=p.id
+       WHERE o.id=? LIMIT 1`, [invitation.order_id])
+    if (p) plan = p
+  }
+
+  // steps din√°micos
+  const steps = [
+    { key:'title',   label:'T√≠tulo' },
+    { key:'date',    label:'Fecha' },
+    { key:'time',    label:'Hora' },
+    { key:'address', label:'Ubicaciones' },
+    { key:'dress',   label:'Vestimenta' },
+    { key:'message', label:'Mensaje' },
+    ...(plan.allow_registry ? [{ key:'registry', label:'Mesa de regalos' }] : []),
+    ...(plan.allow_music    ? [{ key:'music',    label:'M√∫sica' }] : []),
+    { key:'template',label:'Plantilla' },
+    { key:'preview', label:'Preview / Publicar' },
+  ]
+
   res.render('panel/wizard', {
     invitation,
     templates, cats,
-    title:'Editor'
+    steps, plan,
+    title:'Editor'
   })
 })
 
+// Preview de una invitaci√≥n (desde panel)
+router.get('/preview/:id', requireAuth, async (req,res) => {
+  const id = req.params.id
+  const [[inv]] = await req.db.query('SELECT * FROM invitations WHERE id=? AND user_id=?', [id, req.session.uid])
+  if (!inv) return res.status(404).send('No encontrada')
+
+  // theme base + merge
+  const base = {
+    colors:{bg:'#0e0e1a',text:'#f5f4f7',accent:'#4c3b33',muted:'#b5b1aa',ring:'#cdcbc9'},
+    media:{video:'/public/video/sample.mp4',poster:'/public/img/placeholder.jpg',gallery:[]},
+    copy:{intro:'Reserva la fecha y acomp√°√±anos.'},
+    hero:{mode:'video', overlay:'rgba(0,0,0,.45)'},
+    layout:{}
+  }
+  let theme={}; try{ theme = JSON.parse(inv.theme_json||'{}') }catch{}
+  const merged = {
+    ...base,
+    ...theme,
+    colors:{...base.colors, ...(theme.colors||{})},
+    media:{...base.media,  ...(theme.media||{})},
+    copy:{...base.copy,    ...(theme.copy||{})},
+    hero:{...base.hero,    ...(theme.hero||{})},
+    layout:{...base.layout, ...(theme.layout||{})}
+  }
+
+  // orden: registry ANTES de rsvp, music al final
+  const [planRows] = await req.db.query(
+    `SELECT p.* FROM plans p
+     JOIN orders o ON o.plan_id=p.id
+     WHERE o.id=? LIMIT 1`, [inv.order_id])
+  const plan = planRows?.[0] || {}
+  const pref = inv
+  const order = ["hero","detalles"]
+  if (plan.allow_registry && (pref.registry||'').trim()) order.push("registry")
+  order.push("mensaje","galeria","ubicacion","rsvp")
+  if (plan.allow_music && (pref.music_url||'').trim())   order.push("music")
+  order.push("footer")
+
+  const data = {
+    template_key: inv.template_key || 'default',
+    title:        inv.title || 'Mi Evento',
+    date_iso:     inv.date_iso || new Date().toISOString(),
+    venue:        inv.venue || 'Por definir',
+    address:      inv.address || 'Por definir',
+    church_venue: inv.church_venue || '',
+    church_address: inv.church_address || '',
+    section_order: JSON.stringify(order)
+  }
+  const view = `templates/${data.template_key}`.replace(/^(?!templates\/(default|elegant|fairytale)$).*/,'templates/default')
+  res.render('public', { data, theme: merged, view, tpl: data.template_key, title: 'Preview' })
+})
+
+// --------- API AUTOSAVE ---------
+router.patch('/api/invitations/:id', requireAuth, async (req,res) => {
+  try{
+    const id = req.params.id
+    const uid= req.session.uid
+    const [[inv]] = await req.db.query('SELECT id FROM invitations WHERE id=? AND user_id=? LIMIT 1', [id, uid])
+    if (!inv) return res.sendStatus(404)
+
+    const allow = ['title','date','time','dress_code','message','venue','address','show_map','church_venue','church_address','template_key','registry','music_url','music_autoplay']
+    const data = {}
+    for (const k of allow) if (k in req.body) data[k] = req.body[k]
+    if ('show_map' in data) data.show_map = (data.show_map === 'on') ? 1 : 0
+    if ('music_autoplay' in data) data.music_autoplay = (data.music_autoplay === 'on') ? 1 : 0
+    if ('date' in data || 'time' in data) {
+      const d = ('date' in data) ? data.date : null
+      const t = ('time' in data) ? data.time : null
+      if (d) {
+        const hhmm = t ? `${t}:00` : '00:00:00'
+        data.date_iso = new Date(`${d}T${hhmm}`).toISOString()
+      }
+    }
+    const keys = Object.keys(data)
+    if (keys.length){
+      const sets = keys.map(k=>`${k}=?`).join(', ')
+      const vals = keys.map(k=>data[k])
+      await req.db.query(`UPDATE invitations SET ${sets} WHERE id=?`, [...vals, id])
+    }
+    res.json({ok:true})
+  }catch(e){
+    console.error('autosave PATCH err:', e.message)
+    res.sendStatus(500)
+  }
+})
+
 export default router
diff --git a/views/panel/wizard.ejs b/views/panel/wizard.ejs
new file mode 100644
index 0000000..6f7a3a1
--- /dev/null
+++ b/views/panel/wizard.ejs
@@ -0,0 +1,301 @@
+<section class="container mx-auto px-5 py-6">
+  <h1 class="text-2xl font-bold mb-1">Editor de invitaci√≥n</h1>
+  <p class="text-[var(--ring)] text-sm mb-4">ID: <%= invitation?.id %></p>
+</section>
+
+<!-- Topbar Wizard -->
<div class="sticky top-0 z-20 bg-[color:var(--bg)]/80 backdrop-blur border-b border-white/10">
  <div class="max-w-6xl mx-auto px-4 py-2 flex items-center gap-3">
    <a href="/panel" class="btn btn-ghost text-sm">‚Üê Panel</a>
    <div id="saveState" class="ml-2 text-xs px-2 py-1 rounded-full border border-white/10">Listo</div>
    <div class="ml-auto">
      <button id="btnPreview" type="button" class="btn btn-primary text-sm">Vista previa</button>
    </div>
  </div>
</div>
+
+<form id="wizForm" class="max-w-6xl mx-auto px-4 py-6 grid gap-6">
+  <!-- B√°sicos -->
+  <section class="card rounded-2xl shadow-lg/10">
+    <h3 class="font-display text-xl mb-3">B√°sicos</h3>
+    <div class="grid md:grid-cols-2 gap-4">
+      <label class="block">
+        <span class="block text-sm mb-1">T√≠tulo</span>
+        <input class="rounded bg-black/30 px-3 py-2 w-full" name="title" data-field value="<%= invitation?.title||'' %>" required>
+      </label>
+      <label class="block">
+        <span class="block text-sm mb-1">Fecha</span>
+        <input type="date" class="rounded bg-black/30 px-3 py-2 w-full" name="date" data-field value="<%= invitation?.date?.slice?.(0,10) || '' %>" >
+      </label>
+      <label class="block">
+        <span class="block text-sm mb-1">Hora</span>
+        <input type="time" class="rounded bg-black/30 px-3 py-2 w-full" name="time" data-field value="<%= invitation?.time || '' %>">
+      </label>
+      <label class="block">
+        <span class="block text-sm mb-1">C√≥digo de vestimenta</span>
+        <select class="rounded bg-black/30 px-3 py-2 w-full" name="dress_code" data-field>
+          <% const d=(invitation?.dress_code||''); ['','Formal','Coctel','Etiqueta','Casual elegante','Tem√°tico'].forEach(v=>{ %>
+            <option value="<%= v %>" <%= d===v?'selected':'' %>><%= v || '(No especificar)' %></option>
+          <% }) %>
+        </select>
+      </label>
+    </div>
+  </section>
+
+  <!-- Ubicaciones -->
+  <section class="card rounded-2xl shadow-lg/10">
+    <h3 class="font-display text-xl mb-3">Ubicaciones</h3>
+    <div class="grid md:grid-cols-2 gap-4">
+      <div>
+        <h4 class="text-sm font-semibold mb-2">Recepci√≥n</h4>
+        <label class="block mb-3">
+          <span class="block text-sm mb-1">Lugar</span>
+          <input class="rounded bg-black/30 px-3 py-2 w-full" name="venue" data-field value="<%= invitation?.venue||'' %>" placeholder="Sal√≥n Principal">
+        </label>
+        <label class="block">
+          <span class="block text-sm mb-1">Direcci√≥n</span>
+          <input class="rounded bg-black/30 px-3 py-2 w-full" name="address" data-field value="<%= invitation?.address||'' %>" placeholder="Calle 123, Colonia, Ciudad">
+        </label>
+        <label class="flex items-center gap-2 mt-3">
+          <input type="checkbox" name="show_map" data-field <%= invitation?.show_map ? 'checked' : '' %> >
+          Mostrar mapa
+        </label>
+      </div>
+      <div>
+        <h4 class="text-sm font-semibold mb-2">Templo (opcional)</h4>
+        <label class="block mb-3">
+          <span class="block text-sm mb-1">Lugar</span>
+          <input class="rounded bg-black/30 px-3 py-2 w-full" name="church_venue" data-field value="<%= invitation?.church_venue||'' %>" placeholder="Parroquia‚Ä¶">
+        </label>
+        <label class="block">
+          <span class="block text-sm mb-1">Direcci√≥n</span>
+          <input class="rounded bg-black/30 px-3 py-2 w-full" name="church_address" data-field value="<%= invitation?.church_address||'' %>" placeholder="Direcci√≥n del templo">
+        </label>
+      </div>
+    </div>
+  </section>
+
+  <!-- Mensaje -->
+  <section class="card rounded-2xl shadow-lg/10">
+    <h3 class="font-display text-xl mb-3">Mensaje</h3>
+    <textarea class="rounded bg-black/30 px-3 py-2 w-full" rows="4" name="message" data-field
+      placeholder="Reserva la fecha y acomp√°√±anos a celebrar‚Ä¶"><%= invitation?.message||'' %></textarea>
+  </section>
+
+  <!-- Plantilla -->
+  <section class="card rounded-2xl shadow-lg/10">
+    <h3 class="font-display text-xl mb-3">Plantilla</h3>
+    <div class="grid md:grid-cols-4 gap-3">
+      <% (cats||[]).forEach(c => { %>
+        <% (templates||[]).filter(t=>t.category===c).forEach(t=>{ %>
+          <label class="block border border-white/10 rounded-xl p-2 hover:border-white/30 cursor-pointer">
+            <input type="radio" class="mr-1" name="template_key" data-field value="<%= t.key_name %>" <%= (invitation?.template_key===t.key_name)?'checked':'' %> >
+            <span class="text-sm font-semibold"><%= c %> ‚Äî <%= t.name %></span>
+            <img class="rounded mt-2 aspect-video object-cover w-full" src="<%= t.preview_img || '/public/img/template-placeholder.jpg' %>" alt="">
+          </label>
+        <% }) %>
+      <% }) %>
+    </div>
+  </section>
+
+  <!-- Mesa de regalos -->
+  <% if (plan?.allow_registry) { %>
+  <section class="card rounded-2xl shadow-lg/10">
+    <h3 class="font-display text-xl mb-3">Mesa de regalos</h3>
+    <textarea class="rounded bg-black/30 px-3 py-2 w-full" rows="3" name="registry" data-field
+      placeholder="Un enlace por l√≠nea‚Ä¶"><%= invitation?.registry||'' %></textarea>
+    <p class="text-xs text-[var(--ring)] mt-2">Se mostrar√° ANTES de RSVP en la vista previa.</p>
+  </section>
+  <% } %>
+
+  <!-- M√∫sica -->
+  <% if (plan?.allow_music) { %>
+  <section class="card rounded-2xl shadow-lg/10">
+    <h3 class="font-display text-xl mb-3">M√∫sica</h3>
+    <input class="rounded bg-black/30 px-3 py-2 w-full mb-2" name="music_url" data-field type="url" value="<%= invitation?.music_url||'' %>" placeholder="https://tu-servidor.com/cancion.mp3">
+    <label class="flex items-center gap-2">
+      <input type="checkbox" name="music_autoplay" data-field <%= invitation?.music_autoplay ? 'checked' : '' %> >
+      Autoplay (el navegador puede bloquearlo)
+    </label>
+  </section>
+  <% } %>
+</form>
+
+<script>
+(() => {
+  const form = document.getElementById('wizForm');
+  const state = document.getElementById('saveState');
+  const btnPreview = document.getElementById('btnPreview');
+  const INV_ID = "<%= invitation?.id || '' %>";
+  let dirty = {};
+  let timer = null;
+  let saving = false;
+
+  function setStatus(txt, cls='') {
+    state.textContent = txt;
+    state.className = "ml-2 text-xs px-2 py-1 rounded-full border " + (cls || "border-white/10");
+  }
+  function queue(k, v, type) {
+    if (type === 'checkbox') v = v ? 'on' : '';
+    dirty[k] = v;
+    setStatus('Guardando‚Ä¶', 'border-yellow-500');
+    clearTimeout(timer);
+    timer = setTimeout(flush, 600);
+  }
+  async function flush() {
+    if (!Object.keys(dirty).length || saving) return;
+    saving = true;
+    try {
+      const body = new URLSearchParams(dirty);
+      const res = await fetch(`/panel/api/invitations/${INV_ID}`, {
+        method: 'PATCH',
+        headers: { 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
+        body,
+        credentials: 'same-origin'
+      });
+      if (!res.ok) throw new Error('bad status');
+      dirty = {};
+      setStatus('Guardado', 'border-emerald-500');
+    } catch (e) {
+      console.error(e);
+      setStatus('Error ¬∑ Reintentar', 'border-red-500');
+    } finally { saving = false; }
+  }
+  form.addEventListener('input', (e) => {
+    if (!e.target.matches('[data-field]')) return;
+    queue(e.target.name, e.target.value, e.target.type);
+  });
+  form.addEventListener('change', (e) => {
+    if (!e.target.matches('[data-field]')) return;
+    const isCheckbox = (e.target.type==='checkbox');
+    queue(e.target.name, isCheckbox ? e.target.checked : e.target.value, e.target.type);
+  });
+  window.addEventListener('beforeunload', (e) => {
+    if (Object.keys(dirty).length) { e.preventDefault(); e.returnValue = ''; }
+  });
+  btnPreview?.addEventListener('click', async () => {
+    await flush();
+    window.open(`/panel/preview/${INV_ID}`, '_blank');
+  });
+})();
+</script>
diff --git a/db/migrations/20250819_add_church_fields.sql b/db/migrations/20250819_add_church_fields.sql
new file mode 100644
index 0000000..a3b2b9a
--- /dev/null
+++ b/db/migrations/20250819_add_church_fields.sql
@@ -0,0 +1,8 @@
+-- Agrega campos de templo (opcionales) a invitations
+ALTER TABLE invitations
+  ADD COLUMN IF NOT EXISTS church_venue   VARCHAR(255) NULL AFTER address,
+  ADD COLUMN IF NOT EXISTS church_address VARCHAR(255) NULL AFTER church_venue;
+
+-- Mesa de regalos y m√∫sica (por si no existen)
+ALTER TABLE invitations
+  ADD COLUMN IF NOT EXISTS registry TEXT NULL, ADD COLUMN IF NOT EXISTS music_url VARCHAR(512) NULL, ADD COLUMN IF NOT EXISTS music_autoplay TINYINT(1) DEFAULT 0;
